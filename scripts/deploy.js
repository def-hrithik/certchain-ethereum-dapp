const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

// â”€â”€ Network metadata lookup â”€â”€
const NETWORK_META = {
  ganache:  { name: "Ganache",  chainId: 1337 },
  localhost: { name: "Localhost", chainId: 31337 },
  sepolia:  { name: "Sepolia",  chainId: 11155111 },
};

async function main() {
  const networkName = hre.network.name;
  const isLocal = ["ganache", "localhost", "hardhat"].includes(networkName);
  const meta = NETWORK_META[networkName] || { name: networkName, chainId: 0 };

  console.log(`ðŸš€ Deploying CertificateVerification to ${meta.name} (${networkName})...\n`);

  const [deployer] = await hre.ethers.getSigners();
  console.log("ðŸ“‹ Deployer address:", deployer.address);
  console.log(
    "ðŸ’° Deployer balance:",
    hre.ethers.formatEther(await hre.ethers.provider.getBalance(deployer.address)),
    "ETH\n"
  );

  // â”€â”€ Deploy â”€â”€
  const CertificateVerification = await hre.ethers.getContractFactory("CertificateVerification");
  const contract = await CertificateVerification.deploy();
  await contract.waitForDeployment();

  const contractAddress = await contract.getAddress();
  console.log("âœ… CertificateVerification deployed to:", contractAddress);
  console.log("ðŸ‘‘ Admin address:", deployer.address);

  // â”€â”€ Wait for block confirmations (skip on local chains â€” they mine instantly) â”€â”€
  if (!isLocal) {
    console.log("\nâ³ Waiting for 5 block confirmations...");
    const deployTx = contract.deploymentTransaction();
    if (deployTx) {
      await deployTx.wait(5);
    }
    console.log("âœ… 5 confirmations received.\n");

    // â”€â”€ Etherscan verification note â”€â”€
    console.log("ðŸ” To verify on Etherscan, run:");
    console.log(`   npx hardhat verify --network ${networkName} ${contractAddress}\n`);
  } else {
    console.log("\nâš¡ Local chain detected â€” skipping block confirmations.\n");
  }

  // â”€â”€ Bridge to Frontend: write ABI + address to dapp/src/contract.js â”€â”€
  const artifactPath = path.join(
    __dirname,
    "..",
    "artifacts",
    "contracts",
    "CertificateVerification.sol",
    "CertificateVerification.json"
  );
  const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));

  const frontendDir = path.join(__dirname, "..", "dapp", "src");
  if (!fs.existsSync(frontendDir)) {
    fs.mkdirSync(frontendDir, { recursive: true });
  }

  const contractFileContent = `// Auto-generated by deploy.js â€” do not edit manually
// Network: ${meta.name} (Chain ID ${meta.chainId})
export const CONTRACT_ADDRESS = "${contractAddress}";

export const ADMIN_ADDRESS = "${deployer.address}";

export const NETWORK_NAME = "${meta.name}";

export const CHAIN_ID = ${meta.chainId};

export const CONTRACT_ABI = ${JSON.stringify(artifact.abi, null, 2)};
`;

  const contractFilePath = path.join(frontendDir, "contract.js");
  fs.writeFileSync(contractFilePath, contractFileContent);
  console.log("ðŸ“„ ABI + Address written to dapp/src/contract.js");
  console.log(`ðŸŽ‰ Deployment to ${meta.name} complete!\n`);
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
